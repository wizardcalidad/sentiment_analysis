!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("d3-dsv"),require("topojson-client"),require("vega-format")):"function"==typeof define&&define.amd?define(["exports","vega-util","d3-dsv","topojson-client","vega-format"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.d3,e.topojson,e.vega)}(this,(function(e,t,r,n,o){"use strict";const s=/^([A-Za-z]+:)?\/\//,i=/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp|file|data):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,a=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g,u="file://";async function l(e,t){const r=await this.sanitize(e,t),n=r.href;return r.localFile?this.file(n):this.http(n,t)}async function f(e,r){r=t.extend({},this.options,r);const n=this.fileAccess,o={href:null};let l,f,c;const p=i.test(e.replace(a,""));null!=e&&"string"==typeof e&&p||t.error("Sanitize failure, invalid URI: "+t.stringValue(e));const d=s.test(e);return(c=r.baseURL)&&!d&&(e.startsWith("/")||"/"===c[c.length-1]||(e="/"+e),e=c+e),f=(l=e.startsWith(u))||"file"===r.mode||"http"!==r.mode&&!d&&n,l?e=e.slice(u.length):e.startsWith("//")&&("file"===r.defaultProtocol?(e=e.slice(2),f=!0):e=(r.defaultProtocol||"http")+":"+e),Object.defineProperty(o,"localFile",{value:!!f}),o.href=e,r.target&&(o.target=r.target+""),r.rel&&(o.rel=r.rel+""),"image"===r.context&&r.crossOrigin&&(o.crossOrigin=r.crossOrigin+""),o}function c(e){return e?t=>new Promise((r,n)=>{e.readFile(t,(e,t)=>{e?n(e):r(t)})}):p}async function p(){t.error("No file system access.")}function d(e){return e?async function(r,n){const o=t.extend({},this.options.http,n),s=n&&n.response,i=await e(r,o);return i.ok?t.isFunction(i[s])?i[s]():i.text():t.error(i.status+""+i.statusText)}:h}async function h(){t.error("No HTTP fetch method available.")}const g=e=>!(Number.isNaN(+e)||e instanceof Date),m={boolean:t.toBoolean,integer:t.toNumber,number:t.toNumber,date:t.toDate,string:t.toString,unknown:t.identity},y=[e=>"true"===e||"false"===e||!0===e||!1===e,e=>g(e)&&Number.isInteger(+e),g,e=>!Number.isNaN(Date.parse(e))],b=["boolean","integer","number","date"];function v(e,t){if(!e||!e.length)return"unknown";const r=e.length,n=y.length,o=y.map((e,t)=>t+1);for(let i,a,u=0,l=0;u<r;++u)for(a=t?e[u][t]:e[u],i=0;i<n;++i)if(o[i]&&(null!=(s=a)&&s==s)&&!y[i](a)&&(o[i]=0,++l,l===y.length))return"string";var s;return b[o.reduce((e,t)=>0===e?t:e,0)-1]}function j(e,t){return t.reduce((t,r)=>(t[r]=v(e,r),t),{})}function N(e){const r=function(r,n){const o={delimiter:e};return O(r,n?t.extend(n,o):o)};return r.responseType="text",r}function O(e,n){return n.header&&(e=n.header.map(t.stringValue).join(n.delimiter)+"\n"+e),r.dsvFormat(n.delimiter).parse(e+"")}function T(e,r){const n=r&&r.property?t.field(r.property):t.identity;return!t.isObject(e)||(o=e,"function"==typeof Buffer&&t.isFunction(Buffer.isBuffer)&&Buffer.isBuffer(o))?n(JSON.parse(e)):function(e,t){return t&&t.copy?JSON.parse(JSON.stringify(e)):e}(n(e));var o}O.responseType="text",T.responseType="json";const x={interior:(e,t)=>e!==t,exterior:(e,t)=>e===t};function P(e,r){let o,s,i,a;return e=T(e,r),r&&r.feature?(o=n.feature,i=r.feature):r&&r.mesh?(o=n.mesh,i=r.mesh,a=x[r.filter]):t.error("Missing TopoJSON feature or mesh parameter."),s=(s=e.objects[i])?o(e,s,a):t.error("Invalid TopoJSON object: "+i),s&&s.features||[s]}P.responseType="json";const w={dsv:O,csv:N(","),tsv:N("\t"),json:T,topojson:P};function z(e,r){return arguments.length>1?(w[e]=r,this):t.hasOwnProperty(w,e)?w[e]:null}var F=function(e,t){return r=>({options:r||{},sanitize:f,load:l,fileAccess:!!t,file:c(t),http:d(e)})}("undefined"!=typeof fetch&&fetch,null);e.format=w,e.formats=z,e.inferType=v,e.inferTypes=j,e.loader=F,e.read=function(e,r,n,s){const i=z((r=r||{}).type||"json");return i||t.error("Unknown data format type: "+r.type),e=i(e,r),r.parse&&function(e,t,r,n){if(!e.length)return;const s=o.timeFormatDefaultLocale();r=r||s.timeParse,n=n||s.utcParse;let i,a,u,l,f,c,p=e.columns||Object.keys(e[0]);"auto"===t&&(t=j(e,p));p=Object.keys(t);const d=p.map(e=>{const o=t[e];let s,i;if(o&&(o.startsWith("date:")||o.startsWith("utc:"))){s=o.split(/:(.+)?/,2),i=s[1],("'"===i[0]&&"'"===i[i.length-1]||'"'===i[0]&&'"'===i[i.length-1])&&(i=i.slice(1,-1));return("utc"===s[0]?n:r)(i)}if(!m[o])throw Error("Illegal format pattern: "+e+":"+o);return m[o]});for(u=0,f=e.length,c=p.length;u<f;++u)for(i=e[u],l=0;l<c;++l)a=p[l],i[a]=d[l](i[a])}(e,r.parse,n,s),t.hasOwnProperty(e,"columns")&&delete e.columns,e},e.responseType=function(e){const t=z(e);return t&&t.responseType||"text"},e.typeParsers=m,Object.defineProperty(e,"__esModule",{value:!0})}));