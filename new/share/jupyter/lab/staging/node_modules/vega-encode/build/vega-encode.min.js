!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-scale"),require("vega-util"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scale","vega-util","d3-array","d3-interpolate"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega,e.d3,e.d3)}(this,(function(e,t,n,a,i,r){"use strict";function o(e){t.Transform.call(this,null,e)}function l(e){t.Transform.call(this,null,e)}function s(){return t.ingest({})}function u(e){t.Transform.call(this,null,e)}function d(e){t.Transform.call(this,[],e)}a.inherits(o,t.Transform,{transform(e,a){if(this.value&&!e.modified())return a.StopPropagation;var i=a.dataflow.locale(),r=a.fork(a.NO_SOURCE|a.NO_FIELDS),o=this.value,l=e.scale,s=null==e.count?e.values?e.values.length:10:e.count,u=n.tickCount(l,s,e.minstep),d=e.format||n.tickFormat(i,l,u,e.formatSpecifier,e.formatType,!!e.values),m=e.values?n.validTicks(l,e.values,u):n.tickValues(l,u);return o&&(r.rem=o),o=m.map((e,n)=>t.ingest({index:n/(m.length-1||1),value:e,label:d(e)})),e.extra&&o.length&&o.push(t.ingest({index:-1,extra:{value:o[0].value},label:""})),r.source=o,r.add=o,this.value=o,r}}),a.inherits(l,t.Transform,{transform(e,n){var i=n.dataflow,r=n.fork(n.NO_SOURCE|n.NO_FIELDS),o=e.item||s,l=e.key||t.tupleid,u=this.value;return a.isArray(r.encode)&&(r.encode=null),u&&(e.modified("key")||n.modified(l))&&a.error("DataJoin does not support modified key function or fields."),u||(n=n.addAll(),this.value=u=function(e){const t=a.fastmap().test(e=>e.exit);return t.lookup=n=>t.get(e(n)),t}(l)),n.visit(n.ADD,e=>{const t=l(e);let n=u.get(t);n?n.exit?(u.empty--,r.add.push(n)):r.mod.push(n):(n=o(e),u.set(t,n),r.add.push(n)),n.datum=e,n.exit=!1}),n.visit(n.MOD,e=>{const t=l(e),n=u.get(t);n&&(n.datum=e,r.mod.push(n))}),n.visit(n.REM,e=>{const t=l(e),n=u.get(t);e!==n.datum||n.exit||(r.rem.push(n),n.exit=!0,++u.empty)}),n.changed(n.ADD_MOD)&&r.modifies("datum"),(n.clean()||e.clean&&u.empty>i.cleanThreshold)&&i.runAfter(u.clean),r}}),a.inherits(u,t.Transform,{transform(e,t){var n=t.fork(t.ADD_REM),i=e.mod||!1,r=e.encoders,o=t.encode;if(a.isArray(o)){if(!n.changed()&&!o.every(e=>r[e]))return t.StopPropagation;o=o[0],n.encode=null}var l="enter"===o,s=r.update||a.falsy,u=r.enter||a.falsy,d=r.exit||a.falsy,m=(o&&!l?r[o]:s)||a.falsy;if(t.changed(t.ADD)&&(t.visit(t.ADD,t=>{u(t,e),s(t,e)}),n.modifies(u.output),n.modifies(s.output),m!==a.falsy&&m!==s&&(t.visit(t.ADD,t=>{m(t,e)}),n.modifies(m.output))),t.changed(t.REM)&&d!==a.falsy&&(t.visit(t.REM,t=>{d(t,e)}),n.modifies(d.output)),l||m!==a.falsy){var c=t.MOD|(e.modified()?t.REFLOW:0);l?(t.visit(c,t=>{var a=u(t,e)||i;(m(t,e)||a)&&n.mod.push(t)}),n.mod.length&&n.modifies(u.output)):t.visit(c,t=>{(m(t,e)||i)&&n.mod.push(t)}),n.mod.length&&n.modifies(m.output)}return n.changed()?n:t.StopPropagation}}),a.inherits(d,t.Transform,{transform(e,i){if(null!=this.value&&!e.modified())return i.StopPropagation;var r,o,l,s,u,d=i.dataflow.locale(),m=i.fork(i.NO_SOURCE|i.NO_FIELDS),c=this.value,f=e.type||n.SymbolLegend,p=e.scale,h=+e.limit,g=n.tickCount(p,null==e.count?5:e.count,e.minstep),v=!!e.values||f===n.SymbolLegend,y=e.format||n.labelFormat(d,p,g,f,e.formatSpecifier,e.formatType,v),M=e.values||n.labelValues(p,g);return c&&(m.rem=c),f===n.SymbolLegend?(h&&M.length>h?(i.dataflow.warn("Symbol legend count exceeds limit, filtering items."),c=M.slice(0,h-1),u=!0):c=M,a.isFunction(l=e.size)?(e.values||0!==p(c[0])||(c=c.slice(1)),s=c.reduce((t,n)=>Math.max(t,l(n,e)),0)):l=a.constant(s=l||8),c=c.map((n,a)=>t.ingest({index:a,label:y(n,a,c),value:n,offset:s,size:l(n,e)})),u&&(u=M[c.length],c.push(t.ingest({index:c.length,label:`â€¦${M.length-c.length} entries`,value:u,offset:s,size:l(u,e)})))):f===n.GradientLegend?(r=p.domain(),o=n.scaleFraction(p,r[0],a.peek(r)),M.length<3&&!e.values&&r[0]!==a.peek(r)&&(M=[r[0],a.peek(r)]),c=M.map((e,n)=>t.ingest({index:n,label:y(e,n,M),value:e,perc:o(e)}))):(l=M.length-1,o=n.labelFraction(p),c=M.map((e,n)=>t.ingest({index:n,label:y(e,n,M),value:e,perc:n?o(e):0,perc2:n===l?1:o(M[n+1])}))),m.source=c,m.add=c,this.value=c,m}});const m=e=>e.source.x,c=e=>e.source.y,f=e=>e.target.x,p=e=>e.target.y;function h(e){t.Transform.call(this,{},e)}h.Definition={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"require",type:"signal"},{name:"as",type:"string",default:"path"}]},a.inherits(h,t.Transform,{transform(e,t){var n=e.sourceX||m,i=e.sourceY||c,r=e.targetX||f,o=e.targetY||p,l=e.as||"path",s=e.orient||"vertical",u=e.shape||"line",d=M.get(u+"-"+s)||M.get(u);return d||a.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),t.visit(t.SOURCE,e=>{e[l]=d(n(e),i(e),r(e),o(e))}),t.reflow(e.modified()).modifies(l)}});const g=(e,t,n,a)=>"M"+e+","+t+"L"+n+","+a,v=(e,t,n,a)=>{var i=n-e,r=a-t,o=Math.sqrt(i*i+r*r)/2;return"M"+e+","+t+"A"+o+","+o+" "+180*Math.atan2(r,i)/Math.PI+" 0 1 "+n+","+a},y=(e,t,n,a)=>{const i=n-e,r=a-t,o=.2*(i+r),l=.2*(r-i);return"M"+e+","+t+"C"+(e+o)+","+(t+l)+" "+(n+l)+","+(a-o)+" "+n+","+a},M=a.fastmap({line:g,"line-radial":(e,t,n,a)=>g(t*Math.cos(e),t*Math.sin(e),a*Math.cos(n),a*Math.sin(n)),arc:v,"arc-radial":(e,t,n,a)=>v(t*Math.cos(e),t*Math.sin(e),a*Math.cos(n),a*Math.sin(n)),curve:y,"curve-radial":(e,t,n,a)=>y(t*Math.cos(e),t*Math.sin(e),a*Math.cos(n),a*Math.sin(n)),"orthogonal-horizontal":(e,t,n,a)=>"M"+e+","+t+"V"+a+"H"+n,"orthogonal-vertical":(e,t,n,a)=>"M"+e+","+t+"H"+n+"V"+a,"orthogonal-radial":(e,t,n,a)=>{const i=Math.cos(e),r=Math.sin(e),o=Math.cos(n),l=Math.sin(n);return"M"+t*i+","+t*r+"A"+t+","+t+" 0 0,"+((Math.abs(n-e)>Math.PI?n<=e:n>e)?1:0)+" "+t*o+","+t*l+"L"+a*o+","+a*l},"diagonal-horizontal":(e,t,n,a)=>{const i=(e+n)/2;return"M"+e+","+t+"C"+i+","+t+" "+i+","+a+" "+n+","+a},"diagonal-vertical":(e,t,n,a)=>{const i=(t+a)/2;return"M"+e+","+t+"C"+e+","+i+" "+n+","+i+" "+n+","+a},"diagonal-radial":(e,t,n,a)=>{const i=Math.cos(e),r=Math.sin(e),o=Math.cos(n),l=Math.sin(n),s=(t+a)/2;return"M"+t*i+","+t*r+"C"+s*i+","+s*r+" "+s*o+","+s*l+" "+a*o+","+a*l}});function b(e){t.Transform.call(this,null,e)}b.Definition={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},a.inherits(b,t.Transform,{transform(e,t){var n,r,o,l=e.as||["startAngle","endAngle"],s=l[0],u=l[1],d=e.field||a.one,m=e.startAngle||0,c=null!=e.endAngle?e.endAngle:2*Math.PI,f=t.source,p=f.map(d),h=p.length,g=m,v=(c-m)/i.sum(p),y=i.range(h);for(e.sort&&y.sort((e,t)=>p[e]-p[t]),n=0;n<h;++n)o=p[y[n]],(r=f[y[n]])[s]=g,r[u]=g+=o*v;return this.value=p,t.reflow(e.modified()).modifies(l)}});function S(e){return n.isContinuous(e)&&e!==n.Sequential}const x=a.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","domainImplicit","nice","zero","bins","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function k(e){t.Transform.call(this,null,e),this.modified(!0)}function D(e,t,i){n.isLogarithmic(e)&&(Math.abs(t.reduce((e,t)=>e+(t<0?-1:t>0?1:0),0))!==t.length&&i.warn("Log scale domain includes zero: "+a.stringValue(t)));return t}function T(e,t,i){return a.isFunction(e)&&(t||i)?n.interpolateRange(e,w(t||[0,1],i)):e}function w(e,t){return t?e.slice().reverse():e}function O(e){t.Transform.call(this,null,e)}a.inherits(k,t.Transform,{transform(e,t){var o=t.dataflow,l=this.value,s=function(e){var t,i=e.type,r="";if(i===n.Sequential)return n.Sequential+"-"+n.Linear;(function(e){const t=e.type;return n.isContinuous(t)&&t!==n.Time&&t!==n.UTC&&(e.scheme||e.range&&e.range.length&&e.range.every(a.isString))})(e)&&(r=2===(t=e.rawDomain?e.rawDomain.length:e.domain?e.domain.length+ +(null!=e.domainMid):0)?n.Sequential+"-":3===t?n.Diverging+"-":"");return(r+i||n.Linear).toLowerCase()}(e);for(s in l&&s===l.type||(this.value=l=n.scale(s)()),e)if(!x[s]){if("padding"===s&&S(l.type))continue;a.isFunction(l[s])?l[s](e[s]):o.warn("Unsupported scale property: "+s)}return function(e,t,i){var o=e.type,l=t.round||!1,s=t.range;if(null!=t.rangeStep)s=function(e,t,i){e!==n.Band&&e!==n.Point&&a.error("Only band and point scales support rangeStep.");var r=(null!=t.paddingOuter?t.paddingOuter:t.padding)||0,o=e===n.Point?1:(null!=t.paddingInner?t.paddingInner:t.padding)||0;return[0,t.rangeStep*n.bandSpace(i,o,r)]}(o,t,i);else if(t.scheme&&(s=function(e,t,i){var r,o,l=t.schemeExtent;a.isArray(t.scheme)?o=n.interpolateColors(t.scheme,t.interpolate,t.interpolateGamma):(r=t.scheme.toLowerCase(),(o=n.scheme(r))||a.error("Unrecognized scheme name: "+t.scheme));return i=e===n.Threshold?i+1:e===n.BinOrdinal?i-1:e===n.Quantile||e===n.Quantize?+t.schemeCount||5:i,n.isInterpolating(e)?T(o,l,t.reverse):a.isFunction(o)?n.quantizeInterpolator(T(o,l),i):e===n.Ordinal?o:o.slice(0,i)}(o,t,i),a.isFunction(s))){if(e.interpolator)return e.interpolator(s);a.error(`Scale type ${o} does not support interpolating color schemes.`)}if(s&&n.isInterpolating(o))return e.interpolator(n.interpolateColors(w(s,t.reverse),t.interpolate,t.interpolateGamma));s&&t.interpolate&&e.interpolate?e.interpolate(n.interpolate(t.interpolate,t.interpolateGamma)):a.isFunction(e.round)?e.round(l):a.isFunction(e.rangeRound)&&e.interpolate(l?r.interpolateRound:r.interpolate);s&&e.range(w(s,t.reverse))}(l,e,function(e,t,r){let o=t.bins;if(o&&!a.isArray(o)){const t=e.domain(),n=t[0],r=a.peek(t),l=o.step;let s=null==o.start?n:o.start,u=null==o.stop?r:o.stop;l||a.error("Scale bins parameter missing step property."),s<n&&(s=l*Math.ceil(n/l)),u>r&&(u=l*Math.floor(r/l)),o=i.range(s,u+l/2,l)}o?e.bins=o:e.bins&&delete e.bins;e.type===n.BinOrdinal&&(o?t.domain||t.domainRaw||(e.domain(o),r=o.length):e.bins=e.domain());return r}(l,e,function(e,t,i){var r=function(e,t,n){return t?(e.domain(D(e.type,t,n)),t.length):-1}(e,t.domainRaw,i);if(r>-1)return r;var o,l,s=t.domain,u=e.type,d=t.zero||void 0===t.zero&&function(e){const t=e.type;return!e.bins&&(t===n.Linear||t===n.Pow||t===n.Sqrt)}(e);if(!s)return 0;S(u)&&t.padding&&s[0]!==a.peek(s)&&(s=function(e,t,i,r,o,l){var s=Math.abs(a.peek(i)-i[0]),u=s/(s-2*r),d=e===n.Log?a.zoomLog(t,null,u):e===n.Sqrt?a.zoomPow(t,null,u,.5):e===n.Pow?a.zoomPow(t,null,u,o||1):e===n.Symlog?a.zoomSymlog(t,null,u,l||1):a.zoomLinear(t,null,u);return(t=t.slice())[0]=d[0],t[t.length-1]=d[1],t}(u,s,t.range,t.padding,t.exponent,t.constant));if((d||null!=t.domainMin||null!=t.domainMax||null!=t.domainMid)&&(o=(s=s.slice()).length-1||1,d&&(s[0]>0&&(s[0]=0),s[o]<0&&(s[o]=0)),null!=t.domainMin&&(s[0]=t.domainMin),null!=t.domainMax&&(s[o]=t.domainMax),null!=t.domainMid)){const e=(l=t.domainMid)>s[o]?o+1:l<s[0]?0:o;e!==o&&i.warn("Scale domainMid exceeds domain min or max.",l),s.splice(e,0,l)}e.domain(D(u,s,i)),u===n.Ordinal&&e.unknown(t.domainImplicit?n.scaleImplicit:void 0);t.nice&&e.nice&&e.nice(!0!==t.nice&&n.tickCount(e,t.nice)||null);return s.length}(l,e,o))),t.fork(t.NO_SOURCE|t.NO_FIELDS)}}),a.inherits(O,t.Transform,{transform(e,n){const a=e.modified("sort")||n.changed(n.ADD)||n.modified(e.sort.fields)||n.modified("datum");return a&&n.source.sort(t.stableCompare(e.sort)),this.modified(a),n}});const A="zero",C="center",L="normalize",z=["y0","y1"];function P(e){t.Transform.call(this,null,e)}function E(e,t,n,a,i){for(var r,o=(t-e.sum)/2,l=e.length,s=0;s<l;++s)(r=e[s])[a]=o,r[i]=o+=Math.abs(n(r))}function F(e,t,n,a,i){for(var r,o=1/e.sum,l=0,s=e.length,u=0,d=0;u<s;++u)(r=e[u])[a]=l,r[i]=l=o*(d+=Math.abs(n(r)))}function R(e,t,n,a,i){for(var r,o,l=0,s=0,u=e.length,d=0;d<u;++d)(r=+n(o=e[d]))<0?(o[a]=s,o[i]=s+=r):(o[a]=l,o[i]=l+=r)}P.Definition={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:A,values:[A,C,L]},{name:"as",type:"string",array:!0,length:2,default:z}]},a.inherits(P,t.Transform,{transform(e,n){var i,r,o,l,s=e.as||z,u=s[0],d=s[1],m=t.stableCompare(e.sort),c=e.field||a.one,f=e.offset===C?E:e.offset===L?F:R;for(i=function(e,t,n,a){var i,r,o,l,s,u,d,m,c,f=[],p=e=>e(s);if(null==t)f.push(e.slice());else for(i={},r=0,o=e.length;r<o;++r)s=e[r],(d=i[u=t.map(p)])||(i[u]=d=[],f.push(d)),d.push(s);for(u=0,c=0,l=f.length;u<l;++u){for(r=0,m=0,o=(d=f[u]).length;r<o;++r)m+=Math.abs(a(d[r]));d.sum=m,m>c&&(c=m),n&&d.sort(n)}return f.max=c,f}(n.source,e.groupby,m,c),r=0,o=i.length,l=i.max;r<o;++r)f(i[r],l,c,u,d);return n.reflow(e.modified()).modifies(s)}}),e.axisticks=o,e.datajoin=l,e.encode=u,e.legendentries=d,e.linkpath=h,e.pie=b,e.scale=k,e.sortitems=O,e.stack=P,Object.defineProperty(e,"__esModule",{value:!0})}));