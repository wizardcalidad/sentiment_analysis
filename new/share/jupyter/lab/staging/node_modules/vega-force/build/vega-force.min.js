!function(e,a){"object"==typeof exports&&"undefined"!=typeof module?a(exports,require("vega-dataflow"),require("vega-util"),require("d3-force")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-force"],a):a(((e="undefined"!=typeof globalThis?globalThis:e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3)}(this,(function(e,a,t,r){"use strict";const n={center:r.forceCenter,collide:r.forceCollide,nbody:r.forceManyBody,link:r.forceLink,x:r.forceX,y:r.forceY},o="forces",i=["alpha","alphaMin","alphaTarget","velocityDecay","forces"],f=["static","iterations"],s=["x","y","vx","vy"];function l(e){a.Transform.call(this,null,e)}function u(e,a,r,n){var f,s,l,u,m=t.array(a.forces);for(f=0,s=i.length;f<s;++f)(l=i[f])!==o&&a.modified(l)&&e[l](a[l]);for(f=0,s=m.length;f<s;++f)u=o+f,(l=r||a.modified(o,f)?c(m[f]):n&&d(m[f],n)?e.force(u):null)&&e.force(u,l);for(s=e.numForces||0;f<s;++f)e.force(o+f,null);return e.numForces=m.length,e}function d(e,a){var r,n;for(r in e)if(t.isFunction(n=e[r])&&a.modified(t.accessorFields(n)))return 1;return 0}function c(e){var a,r;for(r in t.hasOwnProperty(n,e.force)||t.error("Unrecognized force: "+e.force),a=n[e.force](),e)t.isFunction(a[r])&&m(a[r],e[r],e);return a}function m(e,a,r){e(t.isFunction(a)?e=>a(e,r):a)}l.Definition={type:"Force",metadata:{modifies:!0},params:[{name:"static",type:"boolean",default:!1},{name:"restart",type:"boolean",default:!1},{name:"iterations",type:"number",default:300},{name:"alpha",type:"number",default:1},{name:"alphaMin",type:"number",default:.001},{name:"alphaTarget",type:"number",default:0},{name:"velocityDecay",type:"number",default:.4},{name:"forces",type:"param",array:!0,params:[{key:{force:"center"},params:[{name:"x",type:"number",default:0},{name:"y",type:"number",default:0}]},{key:{force:"collide"},params:[{name:"radius",type:"number",expr:!0},{name:"strength",type:"number",default:.7},{name:"iterations",type:"number",default:1}]},{key:{force:"nbody"},params:[{name:"strength",type:"number",default:-30},{name:"theta",type:"number",default:.9},{name:"distanceMin",type:"number",default:1},{name:"distanceMax",type:"number"}]},{key:{force:"link"},params:[{name:"links",type:"data"},{name:"id",type:"field"},{name:"distance",type:"number",default:30,expr:!0},{name:"strength",type:"number",expr:!0},{name:"iterations",type:"number",default:1}]},{key:{force:"x"},params:[{name:"strength",type:"number",default:.1},{name:"x",type:"field"}]},{key:{force:"y"},params:[{name:"strength",type:"number",default:.1},{name:"y",type:"field"}]}]},{name:"as",type:"string",array:!0,modify:!1,default:s}]},t.inherits(l,a.Transform,{transform(e,a){var t,n,o=this.value,s=a.changed(a.ADD_REM),l=e.modified(i),d=e.iterations||300;if(o?(s&&(a.modifies("index"),o.nodes(a.source)),(l||a.changed(a.MOD))&&u(o,e,0,a)):(this.value=o=function(e,a){const t=r.forceSimulation(e),n=t.stop,o=t.restart;let i=!1;return t.stopped=()=>i,t.restart=()=>(i=!1,o()),t.stop=()=>(i=!0,n()),u(t,a,!0).on("end",()=>i=!0)}(a.source,e),o.on("tick",(t=a.dataflow,n=this,()=>t.touch(n).run())),e.static||(s=!0,o.tick()),a.modifies("index")),l||s||e.modified(f)||a.changed()&&e.restart)if(o.alpha(Math.max(o.alpha(),e.alpha||1)).alphaDecay(1-Math.pow(o.alphaMin(),1/d)),e.static)for(o.stop();--d>=0;)o.tick();else if(o.stopped()&&o.restart(),!s)return a.StopPropagation;return this.finish(e,a)},finish(e,a){const t=a.dataflow;for(let e,a=this._argops,s=0,l=a.length;s<l;++s)if(e=a[s],e.name===o&&"link"===e.op._argval.force)for(var r,n=e.op._argops,i=0,f=n.length;i<f;++i)if("links"===n[i].name&&(r=n[i].op.source)){t.pulse(r,t.changeset().reflow());break}return a.reflow(e.modified()).modifies(s)}}),e.force=l,Object.defineProperty(e,"__esModule",{value:!0})}));