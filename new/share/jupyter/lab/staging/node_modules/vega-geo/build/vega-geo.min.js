!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-util"),require("d3-array"),require("vega-statistics"),require("vega-projection"),require("d3-geo"),require("d3-color"),require("vega-canvas")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-util","d3-array","vega-statistics","vega-projection","d3-geo","d3-color","vega-canvas"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.d3,e.vega,e.vega,e.d3,e.d3,e.vega)}(this,(function(e,t,n,r,a,i,o,s,u){"use strict";function l(){}const f=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function d(){var e=1,t=1,r=s;function a(e,t){return t.map(t=>i(e,t))}function i(n,a){var i=[],s=[];return function(n,r,a){var i,s,u,l,d,c,m=new Array,p=new Array;i=s=-1,l=n[0]>=r,f[l<<1].forEach(h);for(;++i<e-1;)u=l,l=n[i+1]>=r,f[u|l<<1].forEach(h);f[l<<0].forEach(h);for(;++s<t-1;){for(i=-1,l=n[s*e+e]>=r,d=n[s*e]>=r,f[l<<1|d<<2].forEach(h);++i<e-1;)u=l,l=n[s*e+e+i+1]>=r,c=d,d=n[s*e+i+1]>=r,f[u|l<<1|d<<2|c<<3].forEach(h);f[l|d<<3].forEach(h)}i=-1,d=n[s*e]>=r,f[d<<2].forEach(h);for(;++i<e-1;)c=d,d=n[s*e+i+1]>=r,f[d<<2|c<<3].forEach(h);function h(e){var t,n,r=[e[0][0]+i,e[0][1]+s],u=[e[1][0]+i,e[1][1]+s],l=o(r),f=o(u);(t=p[l])?(n=m[f])?(delete p[t.end],delete m[n.start],t===n?(t.ring.push(u),a(t.ring)):m[t.start]=p[n.end]={start:t.start,end:n.end,ring:t.ring.concat(n.ring)}):(delete p[t.end],t.ring.push(u),p[t.end=f]=t):(t=m[f])?(n=p[l])?(delete m[t.start],delete p[n.end],t===n?(t.ring.push(u),a(t.ring)):m[n.start]=p[t.end]={start:n.start,end:t.end,ring:n.ring.concat(t.ring)}):(delete m[t.start],t.ring.unshift(r),m[t.start=l]=t):m[l]=p[f]={start:l,end:f,ring:[r,u]}}f[d<<3].forEach(h)}(n,a,e=>{r(e,n,a),function(e){var t=0,n=e.length,r=e[n-1][1]*e[0][0]-e[n-1][0]*e[0][1];for(;++t<n;)r+=e[t-1][1]*e[t][0]-e[t-1][0]*e[t][1];return r}(e)>0?i.push([e]):s.push(e)}),s.forEach(e=>{for(var t,n=0,r=i.length;n<r;++n)if(-1!==c((t=i[n])[0],e))return void t.push(e)}),{type:"MultiPolygon",value:a,coordinates:i}}function o(t){return 2*t[0]+t[1]*(e+1)*4}function s(n,r,a){n.forEach(n=>{var i,o=n[0],s=n[1],u=0|o,l=0|s,f=r[l*e+u];o>0&&o<e&&u===o&&(i=r[l*e+u-1],n[0]=o+(a-i)/(f-i)-.5),s>0&&s<t&&l===s&&(i=r[(l-1)*e+u],n[1]=s+(a-i)/(f-i)-.5)})}return a.contour=i,a.size=function(r){if(!arguments.length)return[e,t];var i=Math.floor(r[0]),o=Math.floor(r[1]);return i>=0&&o>=0||n.error("invalid size"),e=i,t=o,a},a.smooth=function(e){return arguments.length?(r=e?s:l,a):r===s},a}function c(e,t){for(var n,r=-1,a=t.length;++r<a;)if(n=m(e,t[r]))return n;return 0}function m(e,t){for(var n=t[0],r=t[1],a=-1,i=0,o=e.length,s=o-1;i<o;s=i++){var u=e[i],l=u[0],f=u[1],d=e[s],c=d[0],m=d[1];if(p(u,d,t))return 0;f>r!=m>r&&n<(c-l)*(r-f)/(m-f)+l&&(a=-a)}return a}function p(e,t,n){var r,a,i,o;return function(e,t,n){return(t[0]-e[0])*(n[1]-e[1])==(n[0]-e[0])*(t[1]-e[1])}(e,t,n)&&(a=e[r=+(e[0]===t[0])],i=n[r],o=t[r],a<=i&&i<=o||o<=i&&i<=a)}function h(e,t,a){return function(i){var o=n.extent(i),s=a?Math.min(o[0],0):o[0],u=o[1],l=u-s,f=t?r.tickStep(s,u,e):l/(e+1);return r.range(f,u,f)}}function y(e){t.Transform.call(this,null,e)}function g(e,t,n,r,a){const i=e.x1||0,o=e.y1||0,s=t*n<0;function u(e){e.forEach(l)}function l(e){s&&e.reverse(),e.forEach(f)}function f(e){e[0]=(e[0]-i)*t+r,e[1]=(e[1]-o)*n+a}return function(e){return e.coordinates.forEach(u),e}}function v(e,t,n){const r=e>=0?e:a.bandwidthNRD(t,n);return Math.round((Math.sqrt(4*r*r+1)-1)/2)}function b(e){return n.isFunction(e)?e:n.constant(+e)}function x(){var e=e=>e[0],t=e=>e[1],a=n.one,i=[-1,-1],o=960,s=500,u=2;function l(n,l){const f=v(i[0],n,e)>>u,d=v(i[1],n,t)>>u,c=f?f+2:0,m=d?d+2:0,p=2*c+(o>>u),h=2*m+(s>>u),y=new Float32Array(p*h),g=new Float32Array(p*h);let b=y;n.forEach(n=>{const r=c+(+e(n)>>u),i=m+(+t(n)>>u);r>=0&&r<p&&i>=0&&i<h&&(y[r+i*p]+=+a(n))}),f>0&&d>0?(E(p,h,y,g,f),D(p,h,g,y,d),E(p,h,y,g,f),D(p,h,g,y,d),E(p,h,y,g,f),D(p,h,g,y,d)):f>0?(E(p,h,y,g,f),E(p,h,g,y,f),E(p,h,y,g,f),b=g):d>0&&(D(p,h,y,g,d),D(p,h,g,y,d),D(p,h,y,g,d),b=g);const x=l?Math.pow(2,-2*u):1/r.sum(b);for(let e=0,t=p*h;e<t;++e)b[e]*=x;return{values:b,scale:1<<u,width:p,height:h,x1:c,y1:m,x2:c+(o>>u),y2:m+(s>>u)}}return l.x=function(t){return arguments.length?(e=b(t),l):e},l.y=function(e){return arguments.length?(t=b(e),l):t},l.weight=function(e){return arguments.length?(a=b(e),l):a},l.size=function(e){if(!arguments.length)return[o,s];var t=+e[0],r=+e[1];return t>=0&&r>=0||n.error("invalid size"),o=t,s=r,l},l.cellSize=function(e){return arguments.length?((e=+e)>=1||n.error("invalid cell size"),u=Math.floor(Math.log(e)/Math.LN2),l):1<<u},l.bandwidth=function(e){return arguments.length?(1===(e=n.array(e)).length&&(e=[+e[0],+e[0]]),2!==e.length&&n.error("invalid bandwidth"),i=e,l):i},l}function E(e,t,n,r,a){const i=1+(a<<1);for(let o=0;o<t;++o)for(let t=0,s=0;t<e+a;++t)t<e&&(s+=n[t+o*e]),t>=a&&(t>=i&&(s-=n[t-i+o*e]),r[t-a+o*e]=s/Math.min(t+1,e-1+i-t,i))}function D(e,t,n,r,a){const i=1+(a<<1);for(let o=0;o<e;++o)for(let s=0,u=0;s<t+a;++s)s<t&&(u+=n[o+s*e]),s>=a&&(s>=i&&(u-=n[o+(s-i)*e]),r[o+(s-a)*e]=u/Math.min(s+1,t-1+i-s,i))}function z(e){t.Transform.call(this,null,e)}y.Definition={type:"Isocontour",metadata:{generates:!0},params:[{name:"field",type:"field"},{name:"thresholds",type:"number",array:!0},{name:"levels",type:"number"},{name:"nice",type:"boolean",default:!1},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"zero",type:"boolean",default:!0},{name:"smooth",type:"boolean",default:!0},{name:"scale",type:"number",expr:!0},{name:"translate",type:"number",array:!0,expr:!0},{name:"as",type:"string",null:!0,default:"contour"}]},n.inherits(y,t.Transform,{transform(e,a){if(this.value&&!a.changed()&&!e.modified())return a.StopPropagation;var i=a.fork(a.NO_SOURCE|a.NO_FIELDS),o=a.materialize(a.SOURCE).source,s=e.field||n.identity,u=d().smooth(!1!==e.smooth),l=e.thresholds||function(e,t,n){const a=h(n.levels||10,n.nice,!1!==n.zero);return"shared"!==n.resolve?a:a(e.map(e=>r.max(t(e).values)))}(o,s,e),f=null===e.as?null:e.as||"contour",c=[];return o.forEach(r=>{const a=s(r),i=u.size([a.width,a.height])(a.values,n.isArray(l)?l:l(a.values));!function(e,t,r,a){let i=a.scale||t.scale,o=a.translate||t.translate;n.isFunction(i)&&(i=i(r,a));n.isFunction(o)&&(o=o(r,a));if((1===i||null==i)&&!o)return;const s=(n.isNumber(i)?i:i[0])||1,u=(n.isNumber(i)?i:i[1])||1,l=o&&o[0]||0,f=o&&o[1]||0;e.forEach(g(t,s,u,l,f))}(i,a,r,e),i.forEach(e=>{c.push(t.rederive(r,t.ingest(null!=f?{[f]:e}:e)))})}),this.value&&(i.rem=this.value),this.value=i.source=i.add=c,i}}),z.Definition={type:"KDE2D",metadata:{generates:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"x",type:"field",required:!0},{name:"y",type:"field",required:!0},{name:"weight",type:"field"},{name:"groupby",type:"field",array:!0},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number",array:!0,length:2},{name:"counts",type:"boolean",default:!1},{name:"as",type:"string",default:"grid"}]};const S=["x","y","weight","size","cellSize","bandwidth"];function R(e,t){return S.forEach(n=>null!=t[n]?e[n](t[n]):0),e}function w(e){t.Transform.call(this,null,e)}n.inherits(z,t.Transform,{transform(e,r){if(this.value&&!r.changed()&&!e.modified())return r.StopPropagation;var a,i=r.fork(r.NO_SOURCE|r.NO_FIELDS),o=function(e,t){var n,r,a,i,o,s,u=[],l=e=>e(i);if(null==t)u.push(e);else for(n={},r=0,a=e.length;r<a;++r)i=e[r],(s=n[o=t.map(l)])||(n[o]=s=[],s.dims=o,u.push(s)),s.push(i);return u}(r.materialize(r.SOURCE).source,e.groupby),s=(e.groupby||[]).map(n.accessorName),u=R(x(),e),l=e.as||"grid";return a=o.map(n=>t.ingest(function(e,t){for(let n=0;n<s.length;++n)e[s[n]]=t[n];return e}({[l]:u(n,e.counts)},n.dims))),this.value&&(i.rem=this.value),this.value=i.source=i.add=a,i}}),w.Definition={type:"Contour",metadata:{generates:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"values",type:"number",array:!0},{name:"x",type:"field"},{name:"y",type:"field"},{name:"weight",type:"field"},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number"},{name:"count",type:"number"},{name:"nice",type:"boolean",default:!1},{name:"thresholds",type:"number",array:!0},{name:"smooth",type:"boolean",default:!0}]},n.inherits(w,t.Transform,{transform(e,r){if(this.value&&!r.changed()&&!e.modified())return r.StopPropagation;var a,i,o=r.fork(r.NO_SOURCE|r.NO_FIELDS),s=d().smooth(!1!==e.smooth),u=e.values,l=e.thresholds||h(e.count||10,e.nice,!!u),f=e.size;return u||(u=r.materialize(r.SOURCE).source,i=g(a=R(x(),e)(u,!0),a.scale||1,a.scale||1,0,0),f=[a.width,a.height],u=a.values),l=n.isArray(l)?l:l(u),u=s.size(f)(u,l),i&&u.forEach(i),this.value&&(o.rem=this.value),this.value=o.source=o.add=(u||[]).map(t.ingest),o}});var j="Feature",O="FeatureCollection";function T(e){t.Transform.call(this,null,e)}function M(e){t.Transform.call(this,null,e)}function F(e){t.Transform.call(this,null,e)}function C(e){t.Transform.call(this,null,e)}function _(e){t.Transform.call(this,[],e),this.generator=o.geoGraticule()}function q(e){t.Transform.call(this,null,e)}function P(e){if(!n.isFunction(e))return!1;const t=n.toSet(n.accessorFields(e));return t.$x||t.$y||t.$value||t.$max}function A(e){t.Transform.call(this,null,e),this.modified(!0)}function N(e,t,r){n.isFunction(e[t])&&e[t](r)}T.Definition={type:"GeoJSON",metadata:{},params:[{name:"fields",type:"field",array:!0,length:2},{name:"geojson",type:"field"}]},n.inherits(T,t.Transform,{transform(e,t){var r,a=this._features,i=this._points,o=e.fields,s=o&&o[0],u=o&&o[1],l=e.geojson||!o&&n.identity,f=t.ADD;r=e.modified()||t.changed(t.REM)||t.modified(n.accessorFields(l))||s&&t.modified(n.accessorFields(s))||u&&t.modified(n.accessorFields(u)),this.value&&!r||(f=t.SOURCE,this._features=a=[],this._points=i=[]),l&&t.visit(f,e=>a.push(l(e))),s&&u&&(t.visit(f,e=>{var t=s(e),n=u(e);null!=t&&null!=n&&(t=+t)===t&&(n=+n)===n&&i.push([t,n])}),a=a.concat({type:j,geometry:{type:"MultiPoint",coordinates:i}})),this.value={type:O,features:a}}}),M.Definition={type:"GeoPath",metadata:{modifies:!0},params:[{name:"projection",type:"projection"},{name:"field",type:"field"},{name:"pointRadius",type:"number",expr:!0},{name:"as",type:"string",default:"path"}]},n.inherits(M,t.Transform,{transform(e,t){var r=t.fork(t.ALL),a=this.value,o=e.field||n.identity,s=e.as||"path",u=r.SOURCE;!a||e.modified()?(this.value=a=i.getProjectionPath(e.projection),r.materialize().reflow()):u=o===n.identity||t.modified(o.fields)?r.ADD_MOD:r.ADD;var l=function(e,t){var n=e.pointRadius();e.context(null),null!=t&&e.pointRadius(t);return n}(a,e.pointRadius);return r.visit(u,e=>e[s]=a(o(e))),a.pointRadius(l),r.modifies(s)}}),F.Definition={type:"GeoPoint",metadata:{modifies:!0},params:[{name:"projection",type:"projection",required:!0},{name:"fields",type:"field",array:!0,required:!0,length:2},{name:"as",type:"string",array:!0,length:2,default:["x","y"]}]},n.inherits(F,t.Transform,{transform(e,t){var n,r=e.projection,a=e.fields[0],i=e.fields[1],o=e.as||["x","y"],s=o[0],u=o[1];function l(e){var t=r([a(e),i(e)]);t?(e[s]=t[0],e[u]=t[1]):(e[s]=void 0,e[u]=void 0)}return e.modified()?t=t.materialize().reflow(!0).visit(t.SOURCE,l):(n=t.modified(a.fields)||t.modified(i.fields),t.visit(n?t.ADD_MOD:t.ADD,l)),t.modifies(o)}}),C.Definition={type:"GeoShape",metadata:{modifies:!0,nomod:!0},params:[{name:"projection",type:"projection"},{name:"field",type:"field",default:"datum"},{name:"pointRadius",type:"number",expr:!0},{name:"as",type:"string",default:"shape"}]},n.inherits(C,t.Transform,{transform(e,t){var r=t.fork(t.ALL),a=this.value,o=e.as||"shape",s=r.ADD;return a&&!e.modified()||(this.value=a=function(e,t,n){var r=null==n?n=>e(t(n)):r=>{var a=e.pointRadius(),i=e.pointRadius(n)(t(r));return e.pointRadius(a),i};return r.context=t=>(e.context(t),r),r}(i.getProjectionPath(e.projection),e.field||n.field("datum"),e.pointRadius),r.materialize().reflow(),s=r.SOURCE),r.visit(s,e=>e[o]=a),r.modifies(o)}}),_.Definition={type:"Graticule",metadata:{changes:!0,generates:!0},params:[{name:"extent",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"extentMajor",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"extentMinor",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"step",type:"number",array:!0,length:2},{name:"stepMajor",type:"number",array:!0,length:2,default:[90,360]},{name:"stepMinor",type:"number",array:!0,length:2,default:[10,10]},{name:"precision",type:"number",default:2.5}]},n.inherits(_,t.Transform,{transform(e,r){var a,i=this.value,o=this.generator;if(!i.length||e.modified())for(var s in e)n.isFunction(o[s])&&o[s](e[s]);return a=o(),i.length?r.mod.push(t.replace(i[0],a)):r.add.push(t.ingest(a)),i[0]=a,r}}),q.Definition={type:"heatmap",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"color",type:"string",expr:!0},{name:"opacity",type:"number",expr:!0},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"as",type:"string",default:"image"}]},n.inherits(q,t.Transform,{transform(e,t){if(!t.changed()&&!e.modified())return t.StopPropagation;var a=t.materialize(t.SOURCE).source,i="shared"===e.resolve,o=e.field||n.identity,l=function(e,t){let r;n.isFunction(e)?(r=n=>e(n,t),r.dep=P(e)):e?r=n.constant(e):(r=e=>e.$value/e.$max||0,r.dep=!0);return r}(e.opacity,e),f=function(e,t){let r;n.isFunction(e)?(r=n=>s.rgb(e(n,t)),r.dep=P(e)):r=n.constant(s.rgb(e||"#888"));return r}(e.color,e),d=e.as||"image",c={$x:0,$y:0,$value:0,$max:i?r.max(a.map(e=>r.max(o(e).values))):0};return a.forEach(e=>{const t=o(e),a=n.extend({},e,c);i||(a.$max=r.max(t.values||[])),e[d]=function(e,t,r,a){const i=e.width,o=e.height,s=e.x1||0,l=e.y1||0,f=e.x2||i,d=e.y2||o,c=e.values,m=c?e=>c[e]:n.zero,p=u.canvas(f-s,d-l),h=p.getContext("2d"),y=h.getImageData(0,0,f-s,d-l),g=y.data;for(let e=l,n=0;e<d;++e){t.$y=e-l;for(let o=s,u=e*i;o<f;++o,n+=4){t.$x=o-s,t.$value=m(o+u);const e=r(t);g[n+0]=e.r,g[n+1]=e.g,g[n+2]=e.b,g[n+3]=~~(255*a(t))}}return h.putImageData(y,0,0),p}(t,a,f.dep?f:n.constant(f(a)),l.dep?l:n.constant(l(a)))}),t.reflow(!0).modifies(d)}}),n.inherits(A,t.Transform,{transform(e,t){let r=this.value;return!r||e.modified("type")?(this.value=r=function(e){var t=i.projection((e||"mercator").toLowerCase());t||n.error("Unrecognized projection type: "+e);return t()}(e.type),i.projectionProperties.forEach(t=>{null!=e[t]&&N(r,t,e[t])})):i.projectionProperties.forEach(t=>{e.modified(t)&&N(r,t,e[t])}),null!=e.pointRadius&&r.path.pointRadius(e.pointRadius),e.fit&&function(e,t){var r=function(e){return 1===(e=n.array(e)).length?e[0]:{type:O,features:e.reduce((e,t)=>e.concat(function(e){return e.type===O?e.features:n.array(e).filter(e=>null!=e).map(e=>e.type===j?e:{type:j,geometry:e})}(t)),[])}}(t.fit);t.extent?e.fitExtent(t.extent,r):t.size&&e.fitSize(t.size,r)}(r,e),t.fork(t.NO_SOURCE|t.NO_FIELDS)}}),e.contour=w,e.geojson=T,e.geopath=M,e.geopoint=F,e.geoshape=C,e.graticule=_,e.heatmap=q,e.isocontour=y,e.kde2d=z,e.projection=A,Object.defineProperty(e,"__esModule",{value:!0})}));